rem @echo off
rem autorun
setlocal EnableDelayedExpansion

call "@VC_VARS_PATH@/vcvars64.bat"

rem ---------------------- Packing -------------------------------

echo Making zip-version of installer
rem powershell Compress-Archive "@JASP_INSTALL_DIR_NATIVE@/*" "@JASP_BINARY_DIR_NATIVE@/JASP/JASP-@JASP_VERSION@.zip"

echo Melting and Coalescing MSI

rem set MERGE_MODULE_NAME=@VC_MERGE_MODULE_NAME@
rem set MERGE_MODULE_PATH=@VC_TOOLS_REDIST_DIR_VARIABLE@/Redist/MSVC/v143/MergeModules/%MERGE_MODULE_NAME%
set MERGE_MODULE_PATH="C:\Program Files\Microsoft Visual Studio\2022\Community\VC\Redist\MSVC\v143\MergeModules\Microsoft_VC143_CRT_x64.msm"

echo VCToolsRedistDir: @VC_TOOLS_REDIST_DIR_VARIABLE@

copy %MERGE_MODULE_PATH% /Y
"@HEAT_EXECUTABLE@" dir .\Install -cg JASPFiles -gg -scom -sreg -sfrag -srd -dr APPLICATIONFOLDER -var var.JASP_INSTALL_DIR -out JASPFilesFragment.wxs || exit /B 7

rem copy @JASP_BINARY_DIR_NATIVE@\jasp.wxi /Y
"@CANDLE_EXECUTABLE@" -arch x64 -dJASP_INSTALL_DIR=@JASP_INSTALL_DIR_NATIVE@  JASPFilesFragment.wxs  || exit /B 8

copy @CMAKE_SOURCE_DIR@\Tools\wix\jasp.wxs /Y
rem copy @CMAKE_SOURCE_DIR@\Tools\wix\jaspLicense.rtf /Y
"@CANDLE_EXECUTABLE@" -dRedistMergeModule=@VC_MERGE_MODULE_NAME@ -arch x64 -dJASP_SOURCE_DIR=@JASP_SOURCE_DIR_NATIVE@ -ext WixUIExtension -ext WixUtilExtension jasp.wxs || exit /B 9

"@LIGHT_EXECUTABLE@" -sval -dRedistMergeModule=@VC_MERGE_MODULE_NAME@ -ext WixUIExtension -ext WixUtilExtension -out JASP\JASP.msi JASPFilesFragment.wixobj jasp.wixobj || exit /B 10

endlocal